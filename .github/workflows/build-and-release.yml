#
# build-and-release.yml
# Applite
#
# Created by Mil√°n V√°rady on 2025.07.24.
# Created by Dr Bill Mcilhargey on 2025.07.24.
#
# GitHub Actions workflow for building and releasing macOS application
# Supports Debug/Release configurations with optional code signing and DMG creation
#

name: Build and Release

on:
  workflow_dispatch:
    inputs:
      configuration:
        description: 'Build configuration'
        required: true
        default: 'Debug'
        type: choice
        options:
          - Debug
          - Release
      code_signing:
        description: 'Enable code signing'
        required: true
        default: false
        type: boolean
      create_dmg:
        description: 'Create DMG package'
        required: true
        default: false
        type: boolean

env:
  # Project configuration
  XCODE_PROJECT: "Applite.xcodeproj"
  DERIVED_DATA_PATH: "DerivedData"
  
  # Code signing configuration  
  CODE_SIGN_IDENTITY: "Developer ID Application"
  PROVISIONING_PROFILE_SPECIFIER: "Applite Distribution"
  
  # Default fallback values
  SWIFT_VERSION_DEFAULT: "6.0"
  MACOS_TARGET_DEFAULT: "13.0"
  
  # Dynamic artifact naming
  ARTIFACT_NAME_RELEASE: "Applite"
  ARTIFACT_NAME_DEBUG: "Applite-Debug"

jobs:
  build:
    runs-on: macos-15
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Apple Certificate
      if: ${{ github.event.inputs.code_signing == 'true' }}
      uses: apple-actions/import-codesign-certs@v2
      with:
        p12-file-base64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
        p12-password: ${{ secrets.P12_PASSWORD }}
    
    - name: Install provisioning profile
      if: ${{ github.event.inputs.code_signing == 'true' }}
      uses: apple-actions/download-provisioning-profiles@v1
      with:
        bundle-id: ${{ env.BUNDLE_ID }}
        issuer-id: ${{ secrets.APPSTORE_ISSUER_ID }}
        api-key-id: ${{ secrets.APPSTORE_KEY_ID }}
        api-private-key: ${{ secrets.APPSTORE_PRIVATE_KEY }}
    
    - name: Setup environment variables
      run: |
        get_environment_info() {
          MACOS_VERSION=$(sw_vers -productVersion)
          MACOS_BUILD=$(sw_vers -buildVersion)
          
          XCODE_VERSION_OUTPUT=$(xcodebuild -version 2>/dev/null || echo "Xcode 16.0\nBuild version 16A242d")
          XCODE_VERSION=$(echo "$XCODE_VERSION_OUTPUT" | head -1 | awk '{print $2}')
          XCODE_BUILD=$(echo "$XCODE_VERSION_OUTPUT" | tail -1 | awk '{print $3}')
          XCODE_MAJOR_VERSION=$(echo $XCODE_VERSION | cut -d. -f1)
          XCODE_PATH=$(xcode-select -p)
          
          SWIFT_VERSION=$(grep -o 'SWIFT_VERSION = [^;]*' ${{ env.XCODE_PROJECT }}/project.pbxproj | head -1 | cut -d' ' -f3 | tr -d ';' || echo "${{ env.SWIFT_VERSION_DEFAULT }}")
          MACOS_TARGET=$(grep -o 'MACOSX_DEPLOYMENT_TARGET = [^;]*' ${{ env.XCODE_PROJECT }}/project.pbxproj | head -1 | cut -d' ' -f3 | tr -d ';' || echo "${{ env.MACOS_TARGET_DEFAULT }}")
          XCODE_COMPATIBILITY=$(grep -o 'compatibilityVersion = "[^"]*"' ${{ env.XCODE_PROJECT }}/project.pbxproj | head -1 | cut -d'"' -f2 || echo "Xcode 14.0")
          SCHEME=$(grep -o 'name = [^;]*;' ${{ env.XCODE_PROJECT }}/project.pbxproj | grep -v 'productName' | head -1 | cut -d' ' -f3 | tr -d ';' || echo "Applite")
          BUNDLE_ID=$(grep -o 'PRODUCT_BUNDLE_IDENTIFIER = [^;]*' ${{ env.XCODE_PROJECT }}/project.pbxproj | head -1 | cut -d' ' -f3 | tr -d ';' || echo "dev.aerolite.Applite")
          
          {
            echo "MACOS_VERSION=$MACOS_VERSION"
            echo "MACOS_BUILD=$MACOS_BUILD"
            echo "XCODE_VERSION=$XCODE_VERSION"
            echo "XCODE_BUILD=$XCODE_BUILD"
            echo "XCODE_MAJOR_VERSION=$XCODE_MAJOR_VERSION"
            echo "XCODE_PATH=$XCODE_PATH"
            echo "SWIFT_VERSION=${SWIFT_VERSION:-${{ env.SWIFT_VERSION_DEFAULT }}}"
            echo "MACOS_TARGET=${MACOS_TARGET:-${{ env.MACOS_TARGET_DEFAULT }}}"
            echo "XCODE_COMPATIBILITY=${XCODE_COMPATIBILITY:-Xcode 14.0}"
            echo "SCHEME=${SCHEME:-Applite}"
            echo "BUNDLE_ID=${BUNDLE_ID:-dev.aerolite.Applite}"
          } >> $GITHUB_ENV
        }
        
        get_environment_info
    
    - name: Prepare build environment
      run: |
        echo "üîÑ Preparing build environment..."
        
        # Create build info templates using direct variable substitution
        {
          echo "Build Environment:"
          echo "================="
          echo "System:"
          echo "  ‚Ä¢ macOS: $MACOS_VERSION ($MACOS_BUILD)"
          echo "  ‚Ä¢ Runner: macos-15"
          echo "  ‚Ä¢ Xcode Installed: $XCODE_VERSION ($XCODE_BUILD)"
          echo ""
          echo "Project Configuration:"
          echo "  ‚Ä¢ Xcode Project: ${{ env.XCODE_PROJECT }}"
          echo "  ‚Ä¢ Scheme: $SCHEME"
          echo "  ‚Ä¢ Xcode Targeted: $XCODE_COMPATIBILITY"
          echo "  ‚Ä¢ Swift Version: $SWIFT_VERSION"
          echo "  ‚Ä¢ macOS Targeted: $MACOS_TARGET"
          echo "  ‚Ä¢ Bundle ID: $BUNDLE_ID"
          echo "  ‚Ä¢ Derived Data Path: ${{ env.DERIVED_DATA_PATH }}"
          echo ""
          echo "Code Signing:"
          echo "  ‚Ä¢ Code Signing: ${{ github.event.inputs.code_signing }}"
          echo "  ‚Ä¢ Code Sign Identity: ${{ env.CODE_SIGN_IDENTITY }}"
          echo "  ‚Ä¢ Provisioning Profile: ${{ env.PROVISIONING_PROFILE_SPECIFIER }}"
          echo ""
          echo "Build Options:"
          echo "  ‚Ä¢ Build Config: ${{ github.event.inputs.configuration }}"
          echo "  ‚Ä¢ Create DMG: ${{ github.event.inputs.create_dmg }}"
        } > /tmp/build_info_console.txt
        
        {
          echo "### System"
          echo "- **macOS:** $MACOS_VERSION ($MACOS_BUILD)"
          echo "- **Runner:** macos-15"
          echo "- **Xcode Installed:** $XCODE_VERSION ($XCODE_BUILD)"
          echo ""
          echo "### Project Configuration"
          echo "- **Xcode Project:** ${{ env.XCODE_PROJECT }}"
          echo "- **Scheme:** $SCHEME"
          echo "- **Xcode Targeted:** $XCODE_COMPATIBILITY"
          echo "- **Swift Version:** $SWIFT_VERSION"
          echo "- **macOS Targeted:** $MACOS_TARGET"
          echo "- **Bundle ID:** $BUNDLE_ID"
          echo "- **Derived Data Path:** ${{ env.DERIVED_DATA_PATH }}"
          echo ""
          echo "### Code Signing"
          echo "- **Code Signing:** ${{ github.event.inputs.code_signing }}"
          echo "- **Code Sign Identity:** ${{ env.CODE_SIGN_IDENTITY }}"
          echo "- **Provisioning Profile:** ${{ env.PROVISIONING_PROFILE_SPECIFIER }}"
          echo ""
          echo "### Build Options"
          echo "- **Build Config:** ${{ github.event.inputs.configuration }}"
          echo "- **Create DMG:** ${{ github.event.inputs.create_dmg }}"
        } > /tmp/build_info_markdown.txt
        
        cat /tmp/build_info_console.txt
        echo ""
        
        rm -rf ${{ env.DERIVED_DATA_PATH }} ~/Library/Developer/Xcode/DerivedData/Applite-* ~/Library/Caches/org.swift.swiftpm
        rm -f build_output.log *.dmg

    - name: Resolve package dependencies
      run: |
        echo "üîÑ Resolving Swift package dependencies..."
        xcodebuild -resolvePackageDependencies \
          -project "${{ env.XCODE_PROJECT }}" \
          -scheme "$SCHEME" \
          -derivedDataPath ${{ env.DERIVED_DATA_PATH }} \
          -quiet
        echo "‚úÖ Package dependencies resolved"

    - name: Build application
      run: |
        echo "üî® Building Applite (${{ github.event.inputs.configuration }})..."
        
        BUILD_ARGS=(
          -project "${{ env.XCODE_PROJECT }}"
          -scheme "$SCHEME"
          -configuration "${{ github.event.inputs.configuration }}"
          -derivedDataPath ${{ env.DERIVED_DATA_PATH }}
          -skipPackagePluginValidation
          -disableAutomaticPackageResolution
          -quiet
          -hideShellScriptEnvironment
          SWIFT_TREAT_WARNINGS_AS_ERRORS=NO
        )
        
        if [ "$XCODE_MAJOR_VERSION" -ge 15 ]; then
          BUILD_ARGS+=(-skipMacroValidation)
        fi
        
        if [ "${{ github.event.inputs.code_signing }}" = "true" ]; then
          BUILD_ARGS+=(CODE_SIGN_IDENTITY="${{ env.CODE_SIGN_IDENTITY }}")
          BUILD_ARGS+=(PROVISIONING_PROFILE_SPECIFIER="${{ env.PROVISIONING_PROFILE_SPECIFIER }}")
          echo "üîê Code signing enabled"
        else
          BUILD_ARGS+=(CODE_SIGN_IDENTITY="" CODE_SIGN_ENTITLEMENTS="")
          echo "üö´ Code signing disabled"
        fi
        
        BUILD_ARGS+=(build)
        
        set +e
        xcodebuild "${BUILD_ARGS[@]}" 2>&1 | tee build_output.log
        BUILD_EXIT_CODE=${PIPESTATUS[0]}
        set -e
        
        if [ $BUILD_EXIT_CODE -eq 0 ]; then
          echo "‚úÖ Build completed successfully!"
        else
          echo "‚ùå Build failed with exit code: $BUILD_EXIT_CODE"
          echo "üîç Last 50 lines of build output:"
          tail -50 build_output.log
          exit $BUILD_EXIT_CODE
        fi
    
    - name: Create DMG
      if: ${{ github.event.inputs.create_dmg == 'true' }}
      run: |
        echo "üì¶ Creating DMG package..."
        
        APP_PATH=$(find ${{ env.DERIVED_DATA_PATH }} -name "Applite.app" -type d | head -1)
        
        if [ -z "$APP_PATH" ]; then
          echo "‚ùå Could not find Applite.app"
          exit 1
        fi
        
        mkdir -p dist
        ln -s /Applications dist/Applications
        cp -R "$APP_PATH" dist/
        
        DMG_NAME="Applite-${{ github.event.inputs.configuration }}.dmg"
        hdiutil create -volname "Applite" -srcfolder dist -ov -format UDZO "$DMG_NAME"
        
        DMG_SIZE=$(ls -lh "$DMG_NAME" | awk '{print $5}')
        echo "‚úÖ DMG created: $DMG_NAME ($DMG_SIZE)"
    
    - name: Notarize DMG
      if: ${{ github.event.inputs.code_signing == 'true' && github.event.inputs.create_dmg == 'true' }}
      run: |
        echo "üîí Notarizing DMG..."
        xcrun notarytool submit "Applite-${{ github.event.inputs.configuration }}.dmg" \
          --issuer ${{ secrets.APPSTORE_ISSUER_ID }} \
          --key-id ${{ secrets.APPSTORE_KEY_ID }} \
          --key ${{ secrets.APPSTORE_PRIVATE_KEY }} \
          --wait
        echo "‚úÖ Notarization completed"
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ github.event.inputs.configuration == 'Release' && env.ARTIFACT_NAME_RELEASE || env.ARTIFACT_NAME_DEBUG }}
        path: |
          ${{ env.DERIVED_DATA_PATH }}/Build/Products/${{ github.event.inputs.configuration }}/Applite.app
          *.dmg
        retention-days: 30
    
    - name: Cleanup
      if: always()
      run: |
        rm -rf ${{ env.DERIVED_DATA_PATH }} dist *.dmg build_output.log
        rm -f /tmp/build_info_*.txt /tmp/build_summary.txt
    
    - name: Build Summary
      if: always()
      run: |
        ARTIFACT_NAME="${{ github.event.inputs.configuration == 'Release' && env.ARTIFACT_NAME_RELEASE || env.ARTIFACT_NAME_DEBUG }}"
        
        # Console summary
        {
          echo "üìä Build Summary"
          echo "==============="
          echo ""
          cat /tmp/build_info_console.txt
          echo ""
          echo "Repository: ${{ github.repository }}"
          echo "Status: ${{ job.status }}"
          echo ""
          
          case "${{ job.status }}" in
            "success")
              echo "‚úÖ Build completed successfully!"
              echo ""
              echo "üì¶ Download artifact: $ARTIFACT_NAME"
              ;;
            "failure")
              echo "‚ùå Build failed - check logs above for details"
              ;;
            "cancelled")
              echo "‚èπÔ∏è Build cancelled"
              ;;
          esac
        } | tee -a /tmp/build_summary.txt
        
        # GitHub Summary markdown
        {
          echo "# üìä Build Summary"
          echo ""
          echo "## Build Environment"
          echo ""
          cat /tmp/build_info_markdown.txt
          echo ""
          echo "## Build Results"
          echo ""
          echo "**Repository:** ${{ github.repository }}"
          echo "**Status:** ${{ job.status }}"
          echo ""
          
          case "${{ job.status }}" in
            "success")
              echo "‚úÖ **Build completed successfully!**"
              echo ""
              echo "üì¶ **[Download artifact: $ARTIFACT_NAME](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})**"
              ;;
            "failure")
              echo "‚ùå **Build failed** - check logs above for details"
              ;;
            "cancelled")
              echo "‚èπÔ∏è **Build cancelled**"
              ;;
          esac
        } >> $GITHUB_STEP_SUMMARY
        
        # Annotations
        case "${{ job.status }}" in
          "success")
            echo "::notice title=Build Success::Build completed successfully! Artifact: $ARTIFACT_NAME"
            ;;
          "failure")
            echo "::error title=Build Failed::Build failed with configuration ${{ github.event.inputs.configuration }}. Check the build logs for details."
            ;;
          "cancelled")
            echo "::warning title=Build Cancelled::Build was cancelled during execution."
            ;;
        esac
